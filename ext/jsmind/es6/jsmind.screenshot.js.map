{"version":3,"file":"jsmind.screenshot.js","sources":["../src/plugins/jsmind.screenshot.js"],"sourcesContent":["/**\r\n * @license BSD\r\n * @copyright 2014-2023 hizzgdev@163.com\r\n *\r\n * Project Home:\r\n *   https://github.com/hizzgdev/jsmind/\r\n */\r\n\r\nimport jsMind from 'jsmind';\r\nimport domtoimage from 'dom-to-image';\r\n\r\nif (!jsMind) {\r\n    throw new Error('jsMind is not defined');\r\n}\r\n\r\nif (!domtoimage) {\r\n    throw new Error('dom-to-image is required');\r\n}\r\n\r\nconst $ = jsMind.$;\r\n\r\nconst DEFAULT_OPTIONS = {\r\n    filename: null,\r\n    watermark: {\r\n        left: $.w.location,\r\n        right: 'https://github.com/hizzgdev/jsmind',\r\n    },\r\n    background: 'transparent',\r\n};\r\n\r\nclass JmScreenshot {\r\n    constructor(jm, options) {\r\n        var opts = {};\r\n        jsMind.util.json.merge(opts, DEFAULT_OPTIONS);\r\n        jsMind.util.json.merge(opts, options);\r\n\r\n        this.version = '0.2.0';\r\n        this.jm = jm;\r\n        this.options = opts;\r\n        this.dpr = jm.view.device_pixel_ratio;\r\n    }\r\n\r\n    shoot() {\r\n        let c = this.create_canvas();\r\n        let ctx = c.getContext('2d');\r\n        ctx.scale(this.dpr, this.dpr);\r\n        Promise.resolve(ctx)\r\n            .then(() => this.draw_background(ctx))\r\n            .then(() => this.draw_lines(ctx))\r\n            .then(() => this.draw_nodes(ctx))\r\n            .then(() => this.draw_watermark(c, ctx))\r\n            .then(() => this.download(c))\r\n            .then(() => this.clear(c));\r\n    }\r\n\r\n    create_canvas() {\r\n        let c = $.c('canvas');\r\n        const w = this.jm.view.size.w;\r\n        const h = this.jm.view.size.h;\r\n        c.width = w * this.dpr;\r\n        c.height = h * this.dpr;\r\n        c.style.width = w + 'px';\r\n        c.style.height = h + 'px';\r\n\r\n        c.style.visibility = 'hidden';\r\n        this.jm.view.e_panel.appendChild(c);\r\n        return c;\r\n    }\r\n\r\n    clear(c) {\r\n        c.parentNode.removeChild(c);\r\n    }\r\n\r\n    draw_background(ctx) {\r\n        return new Promise(\r\n            function (resolve, _) {\r\n                const bg = this.options.background;\r\n                if (!!bg && bg !== 'transparent') {\r\n                    ctx.fillStyle = this.options.background;\r\n                    ctx.fillRect(0, 0, this.jm.view.size.w, this.jm.view.size.h);\r\n                }\r\n                resolve(ctx);\r\n            }.bind(this)\r\n        );\r\n    }\r\n\r\n    draw_lines(ctx) {\r\n        return new Promise(\r\n            function (resolve, _) {\r\n                this.jm.view.graph.copy_to(ctx, function () {\r\n                    resolve(ctx);\r\n                });\r\n            }.bind(this)\r\n        );\r\n    }\r\n\r\n    draw_nodes(ctx) {\r\n        return domtoimage\r\n            .toSvg(this.jm.view.e_nodes, { style: { zoom: 1 } })\r\n            .then(this.load_image)\r\n            .then(function (img) {\r\n                ctx.drawImage(img, 0, 0);\r\n                return ctx;\r\n            });\r\n    }\r\n\r\n    draw_watermark(c, ctx) {\r\n        ctx.textBaseline = 'bottom';\r\n        ctx.fillStyle = '#000';\r\n        ctx.font = '11px Verdana,Arial,Helvetica,sans-serif';\r\n        if (!!this.options.watermark.left) {\r\n            ctx.textAlign = 'left';\r\n            ctx.fillText(this.options.watermark.left, 5.5, c.height - 2.5);\r\n        }\r\n        if (!!this.options.watermark.right) {\r\n            ctx.textAlign = 'right';\r\n            ctx.fillText(this.options.watermark.right, c.width - 5.5, c.height - 2.5);\r\n        }\r\n        return ctx;\r\n    }\r\n\r\n    load_image(url) {\r\n        return new Promise(function (resolve, reject) {\r\n            let img = new Image();\r\n            img.onload = function () {\r\n                resolve(img);\r\n            };\r\n            img.onerror = reject;\r\n            img.src = url;\r\n        });\r\n    }\r\n\r\n    download(c) {\r\n        var name = (this.options.filename || this.jm.mind.name) + '.png';\r\n\r\n        if (navigator.msSaveBlob && !!c.msToBlob) {\r\n            var blob = c.msToBlob();\r\n            navigator.msSaveBlob(blob, name);\r\n        } else {\r\n            var blob_url = c.toDataURL();\r\n            var anchor = $.c('a');\r\n            if ('download' in anchor) {\r\n                anchor.style.visibility = 'hidden';\r\n                anchor.href = blob_url;\r\n                anchor.download = name;\r\n                $.d.body.appendChild(anchor);\r\n                var evt = $.d.createEvent('MouseEvents');\r\n                evt.initEvent('click', true, true);\r\n                anchor.dispatchEvent(evt);\r\n                $.d.body.removeChild(anchor);\r\n            } else {\r\n                location.href = blob_url;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nlet screenshot_plugin = new jsMind.plugin('screenshot', function (jm, options) {\r\n    var jmss = new JmScreenshot(jm, options);\r\n    jm.screenshot = jmss;\r\n    jm.shoot = function () {\r\n        jmss.shoot();\r\n    };\r\n});\r\n\r\njsMind.register_plugin(screenshot_plugin);\r\n"],"names":["jsMind","Error","domtoimage","$","DEFAULT_OPTIONS","filename","watermark","left","w","location","right","background","JmScreenshot","constructor","jm","options","opts","util","json","merge","this","version","dpr","view","device_pixel_ratio","shoot","c","create_canvas","ctx","getContext","scale","Promise","resolve","then","draw_background","draw_lines","draw_nodes","draw_watermark","download","clear","size","h","width","height","style","visibility","e_panel","appendChild","parentNode","removeChild","_","bg","fillStyle","fillRect","bind","graph","copy_to","toSvg","e_nodes","zoom","load_image","img","drawImage","textBaseline","font","textAlign","fillText","url","reject","Image","onload","onerror","src","name","mind","navigator","msSaveBlob","msToBlob","blob","blob_url","toDataURL","anchor","href","d","body","evt","createEvent","initEvent","dispatchEvent","screenshot_plugin","plugin","jmss","screenshot","register_plugin"],"mappings":";;;;;;;oYAWA,IAAKA,UACD,MAAM,IAAIC,MAAM,yBAGpB,IAAKC,UACD,MAAM,IAAID,MAAM,4BAGpB,MAAME,EAAIH,EAAM,QAACG,EAEXC,EAAkB,CACpBC,SAAU,KACVC,UAAW,CACPC,KAAMJ,EAAEK,EAAEC,SACVC,MAAO,sCAEXC,WAAY,eAGhB,MAAMC,EACFC,YAAYC,EAAIC,GACZ,IAAIC,EAAO,CAAA,EACXhB,EAAM,QAACiB,KAAKC,KAAKC,MAAMH,EAAMZ,GAC7BJ,EAAM,QAACiB,KAAKC,KAAKC,MAAMH,EAAMD,GAE7BK,KAAKC,QAAU,QACfD,KAAKN,GAAKA,EACVM,KAAKL,QAAUC,EACfI,KAAKE,IAAMR,EAAGS,KAAKC,kBACtB,CAEDC,QACI,IAAIC,EAAIN,KAAKO,gBACTC,EAAMF,EAAEG,WAAW,MACvBD,EAAIE,MAAMV,KAAKE,IAAKF,KAAKE,KACzBS,QAAQC,QAAQJ,GACXK,MAAK,IAAMb,KAAKc,gBAAgBN,KAChCK,MAAK,IAAMb,KAAKe,WAAWP,KAC3BK,MAAK,IAAMb,KAAKgB,WAAWR,KAC3BK,MAAK,IAAMb,KAAKiB,eAAeX,EAAGE,KAClCK,MAAK,IAAMb,KAAKkB,SAASZ,KACzBO,MAAK,IAAMb,KAAKmB,MAAMb,IAC9B,CAEDC,gBACI,IAAID,EAAIvB,EAAEuB,EAAE,UACZ,MAAMlB,EAAIY,KAAKN,GAAGS,KAAKiB,KAAKhC,EACtBiC,EAAIrB,KAAKN,GAAGS,KAAKiB,KAAKC,EAQ5B,OAPAf,EAAEgB,MAAQlC,EAAIY,KAAKE,IACnBI,EAAEiB,OAASF,EAAIrB,KAAKE,IACpBI,EAAEkB,MAAMF,MAAQlC,EAAI,KACpBkB,EAAEkB,MAAMD,OAASF,EAAI,KAErBf,EAAEkB,MAAMC,WAAa,SACrBzB,KAAKN,GAAGS,KAAKuB,QAAQC,YAAYrB,GAC1BA,CACV,CAEDa,MAAMb,GACFA,EAAEsB,WAAWC,YAAYvB,EAC5B,CAEDQ,gBAAgBN,GACZ,OAAO,IAAIG,QACP,SAAUC,EAASkB,GACf,MAAMC,EAAK/B,KAAKL,QAAQJ,WAClBwC,GAAa,gBAAPA,IACRvB,EAAIwB,UAAYhC,KAAKL,QAAQJ,WAC7BiB,EAAIyB,SAAS,EAAG,EAAGjC,KAAKN,GAAGS,KAAKiB,KAAKhC,EAAGY,KAAKN,GAAGS,KAAKiB,KAAKC,IAE9DT,EAAQJ,EACxB,EAAc0B,KAAKlC,MAEd,CAEDe,WAAWP,GACP,OAAO,IAAIG,QACP,SAAUC,EAASkB,GACf9B,KAAKN,GAAGS,KAAKgC,MAAMC,QAAQ5B,GAAK,WAC5BI,EAAQJ,EAC5B,GACA,EAAc0B,KAAKlC,MAEd,CAEDgB,WAAWR,GACP,OAAO1B,EAAU,QACZuD,MAAMrC,KAAKN,GAAGS,KAAKmC,QAAS,CAAEd,MAAO,CAAEe,KAAM,KAC7C1B,KAAKb,KAAKwC,YACV3B,MAAK,SAAU4B,GAEZ,OADAjC,EAAIkC,UAAUD,EAAK,EAAG,GACfjC,CACvB,GACK,CAEDS,eAAeX,EAAGE,GAYd,OAXAA,EAAImC,aAAe,SACnBnC,EAAIwB,UAAY,OAChBxB,EAAIoC,KAAO,0CACL5C,KAAKL,QAAQT,UAAUC,OACzBqB,EAAIqC,UAAY,OAChBrC,EAAIsC,SAAS9C,KAAKL,QAAQT,UAAUC,KAAM,IAAKmB,EAAEiB,OAAS,MAExDvB,KAAKL,QAAQT,UAAUI,QACzBkB,EAAIqC,UAAY,QAChBrC,EAAIsC,SAAS9C,KAAKL,QAAQT,UAAUI,MAAOgB,EAAEgB,MAAQ,IAAKhB,EAAEiB,OAAS,MAElEf,CACV,CAEDgC,WAAWO,GACP,OAAO,IAAIpC,SAAQ,SAAUC,EAASoC,GAClC,IAAIP,EAAM,IAAIQ,MACdR,EAAIS,OAAS,WACTtC,EAAQ6B,EACxB,EACYA,EAAIU,QAAUH,EACdP,EAAIW,IAAML,CACtB,GACK,CAED7B,SAASZ,GACL,IAAI+C,GAAQrD,KAAKL,QAAQV,UAAYe,KAAKN,GAAG4D,KAAKD,MAAQ,OAE1D,GAAIE,UAAUC,YAAgBlD,EAAEmD,SAAU,CACtC,IAAIC,EAAOpD,EAAEmD,WACbF,UAAUC,WAAWE,EAAML,EACvC,KAAe,CACH,IAAIM,EAAWrD,EAAEsD,YACbC,EAAS9E,EAAEuB,EAAE,KACjB,GAAI,aAAcuD,EAAQ,CACtBA,EAAOrC,MAAMC,WAAa,SAC1BoC,EAAOC,KAAOH,EACdE,EAAO3C,SAAWmC,EAClBtE,EAAEgF,EAAEC,KAAKrC,YAAYkC,GACrB,IAAII,EAAMlF,EAAEgF,EAAEG,YAAY,eAC1BD,EAAIE,UAAU,SAAS,GAAM,GAC7BN,EAAOO,cAAcH,GACrBlF,EAAEgF,EAAEC,KAAKnC,YAAYgC,EACrC,MACgBxE,SAASyE,KAAOH,CAEvB,CACJ,EAGL,IAAIU,EAAoB,IAAIzF,EAAAA,QAAO0F,OAAO,cAAc,SAAU5E,EAAIC,GAClE,IAAI4E,EAAO,IAAI/E,EAAaE,EAAIC,GAChCD,EAAG8E,WAAaD,EAChB7E,EAAGW,MAAQ,WACPkE,EAAKlE,OACb,CACA,IAEAzB,EAAAA,QAAO6F,gBAAgBJ"}